<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Travel Season Map (P0)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #toolbar {
      position: fixed; z-index: 1000; top: 10px; left: 50px;
      background: #fff; padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #map { height: 100%; }
    .legend { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); font-size:13px; }
    .legend-item { display:flex; align-items:center; gap:6px; margin:4px 0; }
    .swatch { width:14px; height:14px; border-radius:3px; border:1px solid #999; }
  </style>
</head>
<body>
  <div id="toolbar">
    <label for="month">Month: </label>
    <select id="month">
      <option value="jan">Jan</option><option value="feb">Feb</option><option value="mar">Mar</option>
      <option value="apr">Apr</option><option value="may">May</option><option value="jun">Jun</option>
      <option value="jul" selected>Jul</option><option value="aug">Aug</option><option value="sep">Sep</option>
      <option value="oct">Oct</option><option value="nov">Nov</option><option value="dec">Dec</option>
    </select>
  </div>
  <div id="map"></div>
  <script type="module">
    import maplibregl from 'https://esm.sh/maplibre-gl@3.6.2';
    import { Protocol } from 'https://unpkg.com/pmtiles@4.3.0/dist/esm/index.js?module';

    const originalFetch = window.fetch.bind(window);
    window.fetch = async (input, init) => {
      const request = new Request(input, init);
      if (request.url.includes('.pmtiles')) {
        const headers = new Headers(request.headers);
        headers.set('cache-control', 'no-cache');
        return originalFetch(new Request(request, { cache: 'no-store', headers }));
      }
      return originalFetch(request);
    };

    const SEASONS_FILE = 'data/seasons.json';
    // Updated PMTiles (v3) built from the latest GeoParquet, with maxzoom 6 for crisper boundaries
    const PMTILES_URL = 'pmtiles://data/world_admin0_with_seasons_v3.pmtiles';
    const SOURCE_ID = 'countries';
    const SOURCE_LAYER = 'countries';
    const FEATURE_ID_FIELD = 'ADM0_A3';
    const LAYER_ID = 'countries-fill';
    const COLORS = { Peak:'#249c8f', Shoulder:'#f0c34e', Off:'#e24a33', Unknown:'#bdbdbd' };

    const monthSelect = document.getElementById('month');
    let currentMonth = monthSelect.value;
    let seasons = {};
    let mapReady = false;
    let hoveredId = null;
    let activePopupId = null;
    let activePopupName = null;

    const protocol = new Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const BASE_STYLE = {
      version: 8,
      sources: {},
      layers: [
        {
          id: 'background',
          type: 'background',
          paint: { 'background-color': '#e8edf3' }
        }
      ]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style: BASE_STYLE,
      center: [0, 20],
      zoom: 2.2,
      minZoom: 1.5,
      attributionControl: false
    });
    window.travelSeasonsMap = map;

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.AttributionControl({ compact: true }));

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnMove: true,
      offset: 12
    });

    class LegendControl {
      onAdd() {
        this._container = document.createElement('div');
        this._container.className = 'legend maplibregl-ctrl';
        this._container.innerHTML = `
          <div><strong>Season</strong></div>
          <div class="legend-item"><span class="swatch" style="background:${COLORS.Peak}"></span> Peak</div>
          <div class="legend-item"><span class="swatch" style="background:${COLORS.Shoulder}"></span> Shoulder</div>
          <div class="legend-item"><span class="swatch" style="background:${COLORS.Off}"></span> Off</div>
          <div class="legend-item"><span class="swatch" style="background:${COLORS.Unknown}"></span> Unknown</div>
        `;
        return this._container;
      }
      onRemove() {
        if (this._container?.parentNode) {
          this._container.parentNode.removeChild(this._container);
        }
        this._container = undefined;
      }
    }

    function paintExpression() {
      return [
        'case',
        ['==', ['feature-state', 'season'], 'Peak'], COLORS.Peak,
        ['==', ['feature-state', 'season'], 'Shoulder'], COLORS.Shoulder,
        ['==', ['feature-state', 'season'], 'Off'], COLORS.Off,
        COLORS.Unknown
      ];
    }

    function buildPopupHtml(name, iso3, month) {
      const season = seasons[iso3]?.[month] || 'Unknown';
      return `<strong>${name}</strong> (${iso3})<br>${season} season in ${month.toUpperCase()}`;
    }

    function applyMonth(month) {
      currentMonth = month;
      if (!mapReady || !map.getSource(SOURCE_ID)) return;
      Object.entries(seasons).forEach(([iso3, record]) => {
        map.setFeatureState(
          { source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id: iso3 },
          { season: record?.[month] || 'Unknown' }
        );
      });

      if (activePopupId) {
        popup.setHTML(buildPopupHtml(activePopupName, activePopupId, month));
      }
    }

    function clearHoverState() {
      if (!hoveredId || !map.getSource(SOURCE_ID)) return;
      map.setFeatureState({ source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id: hoveredId }, { hover: false });
      hoveredId = null;
    }

    const seasonsPromise = fetch(SEASONS_FILE).then(r => r.json());

    async function ensureSources() {
      if (!map.getSource(SOURCE_ID)) {
        map.addSource(SOURCE_ID, {
          type: 'vector',
          url: PMTILES_URL,
          promoteId: FEATURE_ID_FIELD
        });
      }

      if (!map.getLayer(LAYER_ID)) {
        map.addLayer({
          id: LAYER_ID,
          type: 'fill',
          source: SOURCE_ID,
          'source-layer': SOURCE_LAYER,
          paint: {
            'fill-color': paintExpression(),
            'fill-opacity': [
              'case',
              ['boolean', ['feature-state', 'hover'], false], 0.95,
              0.85
            ],
            'fill-outline-color': [
              'case',
              ['boolean', ['feature-state', 'hover'], false], '#222222',
              '#ffffff'
            ]
          }
        });
      }
    }

    map.on('load', async () => {
      seasons = await seasonsPromise;
      await ensureSources();

      map.addControl(new LegendControl(), 'bottom-left');
      mapReady = true;
      applyMonth(currentMonth);
    });

    map.on('mousemove', LAYER_ID, e => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const id = feature.id;
      if (hoveredId !== id && map.getSource(SOURCE_ID)) {
        clearHoverState();
        hoveredId = id;
        map.setFeatureState({ source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id }, { hover: true });
      }
    });

    map.on('mouseenter', LAYER_ID, () => {
      map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', LAYER_ID, () => {
      map.getCanvas().style.cursor = '';
      clearHoverState();
    });

    map.on('click', LAYER_ID, e => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const iso3 = feature.properties[FEATURE_ID_FIELD] || feature.id;
      const name = feature.properties.NAME_EN || feature.properties.ADM0_A3 || iso3 || 'Unknown';
      activePopupId = iso3;
      activePopupName = name;
      popup
        .setLngLat(e.lngLat)
        .setHTML(buildPopupHtml(name, iso3, currentMonth))
        .addTo(map);
    });

    monthSelect.addEventListener('change', e => applyMonth(e.target.value));
  </script>
</body>
</html>
