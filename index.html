<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Travel Season Map (P0)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #toolbar {
      position: fixed; z-index: 1000; top: 10px; left: 50px;
      background: #fff; padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .toolbar-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    #map { height: 100%; }
    .legend { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); font-size:13px; }
    .legend-item { display:flex; align-items:center; gap:6px; margin:4px 0; }
    .swatch { width:14px; height:14px; border-radius:3px; border:1px solid #999; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="toolbar-row">
      <label for="month">Month:</label>
      <select id="month">
        <option value="jan">Jan</option>
        <option value="feb">Feb</option>
        <option value="mar">Mar</option>
        <option value="apr">Apr</option>
        <option value="may">May</option>
        <option value="jun">Jun</option>
        <option value="jul" selected>Jul</option>
        <option value="aug">Aug</option>
        <option value="sep">Sep</option>
        <option value="oct">Oct</option>
        <option value="nov">Nov</option>
        <option value="dec">Dec</option>
      </select>
    </div>

    <div class="toolbar-row">
      <label for="tripType">Trip type:</label>
      <select id="tripType">
        <option value="any">Any</option>
        <option value="leisure">Leisure</option>
        <option value="touristy">Touristy</option>
        <option value="adventure">Adventure</option>
        <option value="nature">Nature</option>
        <option value="beach">Beach</option>
        <option value="city">City</option>
        <option value="culture">Culture</option>
        <option value="party">Party</option>
      </select>
    </div>

    <div class="toolbar-row">
      <label for="groupType">Group:</label>
      <select id="groupType">
        <option value="any">Any</option>
        <option value="solo">Solo</option>
        <option value="couples">Couples</option>
        <option value="friends">Friends</option>
        <option value="families">Families</option>
      </select>
    </div>
  </div>
  <div id="map"></div>
  <script type="module">
    import maplibregl from 'https://esm.sh/maplibre-gl@3.6.2';
    import { Protocol } from 'https://unpkg.com/pmtiles@4.3.0/dist/esm/index.js?module';

    const originalFetch = window.fetch.bind(window);
    window.fetch = async (input, init) => {
      const request = new Request(input, init);
      if (request.url.includes('.pmtiles')) {
        const headers = new Headers(request.headers);
        headers.set('cache-control', 'no-cache');
        return originalFetch(new Request(request, { cache: 'no-store', headers }));
      }
      return originalFetch(request);
    };

    const SEASONS_FILE = 'data/seasons.json';
    // Updated PMTiles (v3) built from the latest GeoParquet, with maxzoom 6 for crisper boundaries
    const PMTILES_URL = 'pmtiles://data/world_admin0_with_seasons_v3.pmtiles';
    const SOURCE_ID = 'countries';
    const LABELS_SOURCE_ID = 'country-labels';
    const SOURCE_LAYER = 'countries';
    const FEATURE_ID_FIELD = 'ADM0_A3';
    const BASE_LAYER_ID = 'countries-base';
    const LAYER_ID = 'countries-fill';
    const BOUNDARY_LAYER_ID = 'countries-boundary';
    const LABEL_LAYER_ID = 'countries-labels';
    const COLORS = { Peak:'#249c8f', Shoulder:'#f0c34e', Off:'#e24a33', Unknown:'#bdbdbd' };

    const monthSelect = document.getElementById('month');
    const tripTypeSelect = document.getElementById('tripType');
    const groupTypeSelect = document.getElementById('groupType');

    let currentMonth = monthSelect.value;
    let seasons = {};
    let regionVibes = {};
    let mapReady = false;
    let hoveredId = null;
    let activePopupId = null;
    let activePopupName = null;

    const protocol = new Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const BASE_STYLE = {
      version: 8,
      glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
      sources: {},
      layers: [
        {
          id: 'land-mask',
          type: 'background',
          paint: { 'background-color': '#ffffff' }
        },
        {
          id: 'background',
          type: 'background',
          paint: { 'background-color': '#d6ecff' }
        }
      ]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style: BASE_STYLE,
      center: [0, 20],
      zoom: 2.2,
      minZoom: 1.5,
      attributionControl: false
    });
    window.travelSeasonsMap = map;

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.AttributionControl({ compact: true }));

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnMove: true,
      offset: 12
    });

    class LegendControl {
      onAdd() {
        this._container = document.createElement('div');
        this._container.className = 'legend maplibregl-ctrl';
        this._container.innerHTML = `
          <div><strong>Match (Europe)</strong></div>
          <div class="legend-item"><span class="swatch" style="background:#1b8f3a"></span> 100% match</div>
          <div class="legend-item"><span class="swatch" style="background:#7ccf85"></span> ~80% match</div>
          <div class="legend-item"><span class="swatch" style="background:#cdeed0"></span> ~60% match</div>
          <div class="legend-item"><span class="swatch" style="background:#d0d0d0"></span> Low / no match</div>
        `;
        return this._container;
      }
      onRemove() {
        if (this._container?.parentNode) {
          this._container.parentNode.removeChild(this._container);
        }
        this._container = undefined;
      }
    }

    function paintExpression() {
      return [
        'interpolate',
        ['linear'],
        ['coalesce', ['feature-state', 'score'], 0],
        0.0, '#f0f0f0',
        0.6, '#cdeed0',
        1.0, '#1b8f3a'
      ];
    }

    function buildPopupHtml(name, iso3, month) {
      const season = seasons[iso3]?.[month] || 'Unknown';
      const score = overallScore(
        iso3,
        month,
        tripTypeSelect.value,
        groupTypeSelect.value
      );
      const pct = Math.round(score * 100);
      return `
        <strong>${name}</strong> (${iso3})<br>
        ${pct}% match for ${month.toUpperCase()}<br>
        <small>${season} season (climate component)</small>
      `;
    }

    function clearHoverState() {
      if (!hoveredId || !map.getSource(SOURCE_ID)) return;
      map.setFeatureState({ source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id: hoveredId }, { hover: false });
      hoveredId = null;
    }

    const seasonsPromise = fetch(SEASONS_FILE).then(r => r.json());
    const vibesPromise = fetch('data/region_vibes.json').then(r => r.json());

    async function ensureSources() {
      if (!map.getSource(SOURCE_ID)) {
        map.addSource(SOURCE_ID, {
          type: 'vector',
          url: PMTILES_URL,
          promoteId: FEATURE_ID_FIELD
        });
      }

      if (!map.getLayer(BASE_LAYER_ID)) {
        map.addLayer({
          id: BASE_LAYER_ID,
          type: 'fill',
          source: SOURCE_ID,
          'source-layer': SOURCE_LAYER,
          paint: {
            'fill-color': '#ffffff',
            'fill-opacity': 1
          }
        });
      }

      if (!map.getLayer(LAYER_ID)) {
        map.addLayer({
          id: LAYER_ID,
          type: 'fill',
          source: SOURCE_ID,
          'source-layer': SOURCE_LAYER,
          paint: {
            'fill-color': paintExpression(),
            'fill-opacity': [
              'case',
              // hovered feature always bright
              ['boolean', ['feature-state', 'hover'], false], 0.95,
              // otherwise opacity scales with score (0â€“1)
              [
                'interpolate',
                ['linear'],
                ['coalesce', ['feature-state', 'score'], 0],
                0.0, 0.1,
                0.6, 0.5,
                1.0, 0.9
              ]
            ],
            'fill-outline-color': [
              'case',
              ['boolean', ['feature-state', 'hover'], false], '#222222',
              '#d4d6de'
            ]
          }
        });
      }

      if (!map.getLayer(BOUNDARY_LAYER_ID)) {
        map.addLayer({
          id: BOUNDARY_LAYER_ID,
          type: 'line',
          source: SOURCE_ID,
          'source-layer': SOURCE_LAYER,
          paint: {
            'line-color': '#b9bcc6',
            'line-width': [
              'interpolate',
              ['linear'],
              ['zoom'],
              1.5, 0.2,
              4, 0.7
            ],
            'line-opacity': 0.9
          }
        });
      }

      if (!map.getSource(LABELS_SOURCE_ID)) {
        map.addSource(LABELS_SOURCE_ID, {
          type: 'geojson',
          data: 'data/country_labels.geojson'
        });
      }

      if (!map.getLayer(LABEL_LAYER_ID)) {
        map.addLayer({
          id: LABEL_LAYER_ID,
          type: 'symbol',
          source: LABELS_SOURCE_ID,
          layout: {
            'text-field': [
              'get',
              'name'
            ],
            'symbol-placement': 'point',
            'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
            'text-size': 11,
            'text-letter-spacing': 0.05,
            'text-max-width': 8,
            'text-allow-overlap': false
          },
          paint: {
            'text-color': '#2e3d4f',
            'text-halo-color': '#ffffff',
            'text-halo-width': 1.2,
            'text-halo-blur': 0.5
          },
          minzoom: 1.8
        });
      }
    }

    function seasonScore(season) {
      if (season === 'Peak') return 1;
      if (season === 'Shoulder') return 0.7;
      if (season === 'Off') return 0.3;
      return 0;
    }

    function tripMatchScore(regionTags, selectedTrip) {
      if (selectedTrip === 'any') return 1;
      if (!regionTags) return 0;
      return regionTags.includes(selectedTrip) ? 1 : 0;
    }

    function groupMatchScore(regionTags, selectedGroup) {
      if (selectedGroup === 'any') return 1;
      if (!regionTags) return 0;
      return regionTags.includes(selectedGroup) ? 1 : 0;
    }

    function overallScore(regionId, month, tripType, groupType) {
      const season = seasons[regionId]?.[month] || 'Unknown';
      const sScore = seasonScore(season);

      const vibes = regionVibes[regionId];
      if (!vibes) {
        return 0;
      }

      const tScore = tripMatchScore(vibes.trip_types, tripType);
      const gScore = groupMatchScore(vibes.group_types, groupType);

      const wSeason = 0.6;
      const wTrip = 0.25;
      const wGroup = 0.15;
      const raw = wSeason * sScore + wTrip * tScore + wGroup * gScore;

      return Math.max(0, Math.min(1, raw));
    }

    function applyFilters() {
      if (!mapReady || !map.getSource(SOURCE_ID)) return;

      const month = monthSelect.value;
      const tripType = tripTypeSelect.value;
      const groupType = groupTypeSelect.value;
      currentMonth = month;

      Object.entries(seasons).forEach(([regionId, record]) => {
        const season = record?.[month] || 'Unknown';
        const score = overallScore(regionId, month, tripType, groupType);

        map.setFeatureState(
          { source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id: regionId },
          { season, score }
        );
      });

      if (activePopupId) {
        popup.setHTML(buildPopupHtml(activePopupName, activePopupId, month));
      }
    }

    map.on('load', async () => {
      const [seasonsData, vibesData] = await Promise.all([seasonsPromise, vibesPromise]);
      seasons = seasonsData;
      regionVibes = vibesData;
      await ensureSources();

      map.addControl(new LegendControl(), 'bottom-left');
      mapReady = true;
      applyFilters();
    });

    map.on('mousemove', LAYER_ID, e => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const id = feature.id;
      if (hoveredId !== id && map.getSource(SOURCE_ID)) {
        clearHoverState();
        hoveredId = id;
        map.setFeatureState({ source: SOURCE_ID, sourceLayer: SOURCE_LAYER, id }, { hover: true });
      }
    });

    map.on('mouseenter', LAYER_ID, () => {
      map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', LAYER_ID, () => {
      map.getCanvas().style.cursor = '';
      clearHoverState();
    });

    map.on('click', LAYER_ID, e => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const iso3 = feature.properties[FEATURE_ID_FIELD] || feature.id;
      const name = feature.properties.NAME_EN || feature.properties.ADM0_A3 || iso3 || 'Unknown';
      activePopupId = iso3;
      activePopupName = name;
      popup
        .setLngLat(e.lngLat)
        .setHTML(buildPopupHtml(name, iso3, currentMonth))
        .addTo(map);
    });

    monthSelect.addEventListener('change', () => applyFilters());
    tripTypeSelect.addEventListener('change', () => applyFilters());
    groupTypeSelect.addEventListener('change', () => applyFilters());
  </script>
</body>
</html>
